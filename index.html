<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¸‚å†…äººå£å¤šã„ã‚¨ãƒªã‚¢ ãƒ©ãƒ³ãƒ€ãƒ å‡ºåŠ›</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; background:#fafafa; }
    .card { max-width: 960px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }
    .section { background:#fff; border:1px solid #e5e5e5; border-radius: 12px; padding: 16px; }
    .section-title { display:flex; justify-content: space-between; align-items: center; gap:12px; margin-bottom: 6px; }
    .section h2, .section h3 { margin: 0; font-size: 20px; }
    input, select, button { font-size: 16px; padding: 10px; }
    input { width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .muted { color: #666; font-size: 13px; }
    .note { color:#444; font-size: 13px; margin-top: 4px; }
    ul { padding-left: 0; margin: 12px 0 0; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color:#444; }
    .err { color: #b00020; }
    .toast{
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      font-size: 13px;
      color: #111827;
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      pointer-events: none;
      z-index: 9999;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }
    .copy-status { margin-top: 6px; color:#0a6; font-weight:700; font-size:14px; min-height:18px; }
    .controls { margin-top: 12px; }
    .btn { border: 1px solid transparent; border-radius: 8px; padding: 10px 14px; font-weight: 700; }
    .btn-primary { background:#0b79d0; color:#fff; }
    .btn-primary:hover { background:#0969b5; }
    .btn-secondary { background:#f5f5f5; color:#333; border:1px solid #d0d0d0; }
    .btn-secondary:hover { background:#e9e9e9; }

    #q { margin-bottom: 12px; }
    .cityInput{
      border: 1px solid #e5e7eb;
      border-radius: 10px;
    }
    .cityInput::placeholder{
      color:#9ca3af;
    }

    .controlsBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:12px 14px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      background:#fff;
    }

    .controlsLeft, .controlsRight{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .controlsRight{ gap:10px; }

    .control{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fafafa;
      position: relative;
    }

    .control label{
      font-size:12px;
      color:#374151;
      white-space:nowrap;
    }

    .control select, .control input[type="text"]{
      height:34px;
      border:1px solid #d1d5db;
      border-radius:8px;
      padding:0 10px;
      background:#fff;
    }

    /* select ã‚’ä¸¸ãƒãƒƒãƒ—é¢¨ã« */
    .control select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      padding: 0 34px 0 12px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background-color: #fff;
      font-size: 14px;
      cursor: pointer;

      /* çŸ¢å°ã‚’æ¶ˆã™ */
      background-image: none;
    }

    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã‚‚ä¸¸ã„ã¾ã¾ */
    .control select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    .segmented {
      display: flex;
      gap: 6px;
    }

    .segmented button {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    .segmented button:hover {
      background: #f1f5f9;
    }

    .segmented button.active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
      font-weight: 600;
    }

    .checkboxRow{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#f9fafb;
      white-space:nowrap;
    }

    .searchBtn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      height:44px;
      padding:0 16px;
      border-radius:10px;
      border:1px solid #2563eb;
      background:#2563eb;
      color:#fff;
      font-weight:600;
    }

    .searchBtn:hover{ filter:brightness(0.95); }

    /* ---- çµæœã‚«ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼ï¼‰ ---- */
    .result-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #e2e2e2;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      text-align: left;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    .result-item:hover { background: #f4f8ff; }
    .result-item:active { transform: translateY(1px); }
    .result-left { display: flex; flex-direction: column; gap: 4px; }
    .result-name { font-size: 17px; font-weight: 800; }
    .result-pop { font-size: 13px; color: #555; }
    .copy-hint {
      font-size: 12px;
      color: #666;
      border: 1px solid #ddd;
      padding: 4px 10px;
      border-radius: 999px;
      align-self: center;
      white-space: nowrap;
    }

    /* å€™è£œãƒœã‚¿ãƒ³ */
    .cand-btn {
      margin: 4px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      cursor: pointer;
    }
    .cand-btn:hover { background: #f7f7f7; }

    /* ---- ã‚³ãƒ”ãƒ¼å±¥æ­´ ---- */
    #history { padding-left: 0; margin-top: 10px; }
    .history-item {
      display:flex;
      justify-content: space-between;
      gap: 12px;
      width:100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background:#fff;
      cursor:pointer;
      margin: 8px 0;
      text-align: left;
    }
    .history-item:hover { background:#f7f7f7; }
    .history-text { font-weight: 700; }
    .history-meta { font-size: 12px; color:#666; white-space: nowrap; }
    .history-empty { color:#666; font-size: 13px; margin-top: 8px; }

    /* --- è»½ã‚ã®ãƒã‚§ãƒƒã‚¯ãƒ»å…¥åŠ›ãƒ»ãƒœã‚¿ãƒ³æ„Ÿ --- */
    .areaCard{
      position: relative;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease;
    }
    .areaCard:hover{
      background:#f8fafc;
      border-color:#cbd5e1;
    }
    .areaCard:active{
      transform: scale(0.995);
    }
    .areaCard::before{
      content:"ğŸ“‹";
      position:absolute;
      left:12px;
      top:12px;
      font-size:12px;
      opacity:0.45;
    }
    .area-title{
      padding-left: 18px;
    }

    .historyItem{
      background:#fafafa;
      border-color:#e5e7eb;
    }
    .historyItem .historyName{
      font-size: 14px;
    }
    .historyItem .historyTime{
      color:#6b7280;
      font-size:12px;
    }

    /* ===== Mobile layout fix ===== */
    @media (max-width: 600px) {
      /* å…¥åŠ›æ¬„ã¨ä¸‹ã®æ“ä½œæ ã®ä½™ç™½ã‚’ç¢ºä¿ */
      .search-block .search-input {
        margin-bottom: 12px;
      }

      /* æ“ä½œã‚¨ãƒªã‚¢ã‚’ç¸¦ç©ã¿ã« */
      .controls-row {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      /* å·¦(æŠ½å‡ºå€™è£œæ•°/è¡¨ç¤ºä»¶æ•°)ãƒ»å³(å¸‚åãƒã‚§ãƒƒã‚¯/æ¤œç´¢)ã‚’ãã‚Œãã‚Œ100%ã« */
      .controls-left,
      .controls-right {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 10px;
      }

      /* å¸‚åãƒã‚§ãƒƒã‚¯ã®è¡Œï¼šå¹…ã„ã£ã±ã„ */
      .controls-right label {
        width: 100%;
      }

      /* æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã‚„ã™ãï¼šæ¨ªå¹…100% */
      .controls-right .btn-search {
        width: 100%;
        justify-content: center;
        padding: 14px 16px;
        border-radius: 12px;
      }

      /* ãƒœã‚¿ãƒ³ç¾¤ï¼ˆ5/8/10ãªã©ï¼‰ãŒè©°ã¾ã‚‹ã®ã§æŠ˜ã‚Šè¿”ã—è¨±å¯ */
      .segmented {
        flex-wrap: wrap;
      }
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="section search-block">
      <div class="section-title">
        <h2>å¸‚åŒºç”ºæ‘ã‚’å…¥åŠ›</h2>
      </div>
      <p class="muted">éƒ¨åˆ†ä¸€è‡´OKï¼ˆä¾‹ï¼šå·è¶Š ã§ã‚‚OKï¼‰</p>
      <input id="q" class="cityInput search-input" placeholder="ä¾‹ï¼‰å·è¶Šå¸‚ / é‚£è¦‡å¸‚ / æœ­å¹Œå¸‚" />

      <div class="controlsBar controls-row">
        <div class="controlsLeft controls-left">
          <div class="control">
            <label class="control-label"><span>æŠ½å‡ºå€™è£œæ•°</span></label>
            <div class="segmented" id="poolSizeGroup">
              <button type="button" data-value="5">5</button>
              <button type="button" data-value="8">8</button>
              <button type="button" data-value="10">10</button>
            </div>
          </div>

          <div class="control">
            <label class="control-label"><span>è¡¨ç¤ºä»¶æ•°</span></label>
            <div class="segmented" id="displayCountGroup">
              <button type="button" data-value="1">1</button>
              <button type="button" data-value="3">3</button>
              <button type="button" data-value="5">5</button>
            </div>
          </div>
        </div>

        <div class="controlsRight controls-right">
          <label class="checkboxRow">
            <input id="showCityPrefix" type="checkbox" checked />
            <span>å¸‚åã‚’ä»˜ã‘ã¦è¡¨ç¤º</span>
          </label>

          <button id="btn" class="searchBtn btn-search">æ¤œç´¢</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <h3>å€™è£œï¼ˆã‚¯ãƒªãƒƒã‚¯ã§åœ°åã ã‘ã‚³ãƒ”ãƒ¼ï¼‰</h3>
      </div>
      <p class="muted">è¡¨ç¤ºã¯äººå£ä»˜ã / ã‚³ãƒ”ãƒ¼ã¯åœ°åã®ã¿ï¼ˆäººå£ã¯å‚è€ƒè¡¨ç¤ºã§ã™ï¼‰</p>
      <div id="copyStatus" class="copy-status"></div>
      <div id="msg" class="err" style="margin-top:4px;"></div>
      <div id="meta" style="margin-top:8px;"></div>
      <div id="toast" class="toast"></div>

      <ul id="out"></ul>
      <div id="cands" style="margin-top: 12px;"></div>
    </div>

    <div class="section">
      <div class="section-title">
        <h3>ã‚³ãƒ”ãƒ¼å±¥æ­´</h3>
        <button id="clearHistory" type="button" class="btn btn-secondary">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
      <p class="muted">æ¤œç´¢ã§ã‚³ãƒ”ãƒ¼ã—ãŸåœ°åãŒã“ã“ã«æ®‹ã‚Šã¾ã™ã€‚</p>
      <div id="historyEmpty" class="history-empty"></div>
      <ul id="history"></ul>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    let data = null;     // code -> {pref, city, areas:[{name,pop}]}
    let index = null;    // cityName -> [code,...]
    let currentCity = ""; // ç›´è¿‘ã§æ¤œç´¢ãƒ»è¡¨ç¤ºã—ã¦ã„ã‚‹å¸‚åï¼ˆå±¥æ­´è¡¨ç¤ºç”¨ï¼‰
    let currentPref = "";
    const HISTORY_KEY = "copyHistory";
    const LAST_CITY_KEY = "lastSelectedCity";
    const LAST_PREF_KEY = "lastSelectedPref";
    const POOL_SIZE_KEY = "ui_pool_size";
    const DISPLAY_COUNT_KEY = "ui_display_count";
    const HISTORY_MAX = 30;
    let poolSize = Number(localStorage.getItem(POOL_SIZE_KEY)) || 10;
    let displayCount = Number(localStorage.getItem(DISPLAY_COUNT_KEY)) || 3;

    function buildIndex() {
      index = {};
      for (const [code, v] of Object.entries(data)) {
        const city = v.city;
        if (!city) continue;
        if (!index[city]) index[city] = [];
        index[city].push(code);
      }
    }

    function sampleUnique(arr, k) {
      const n = Math.min(k, arr.length);
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    const RE_CODE_TOTAL = /ç”ºä¸å­—ã‚³ãƒ¼ãƒ‰\d+ã®è¨ˆ/;
    const RE_TOTAL_SUFFIX = /(ã®è¨ˆ|è¨ˆ)$/;
    const RE_BAD_WORD = /(ç·æ•°|ä¸è©³)/;

    function displayName(rawName) {
      // è¡¨ç¤ºãƒ»ã‚³ãƒ”ãƒ¼ãƒ»å±¥æ­´ç”¨ã«æ•´å½¢ï¼ˆå…ˆé ­ã®ã€Œå¤§å­—ã€ã€Œå­—ã€ã‚’è½ã¨ã™ï¼‰
      return (rawName || "")
        .replace(/^å¤§å­—/, "")
        .replace(/^å­—/, "")
        .trim()
        .replace(/\s+/g, " ");
    }

    function isBadName(rawName) {
      const name = (rawName || "").trim();
      if (!name) return true;
      if (RE_CODE_TOTAL.test(name)) return true;
      if (RE_BAD_WORD.test(name)) return true;
      if (RE_TOTAL_SUFFIX.test(name)) return true;
      return false;
    }

    function isValidAreaName(areaName) {
      const name = displayName(areaName);
      if (!name) return false;
      if (isBadName(areaName) || isBadName(name)) return false;
      if (/^\d+$/.test(name)) return false;
      return true;
    }

    function filterAreas(list) {
      const seen = new Set();
      const filtered = [];
      for (const a of list) {
        const rawName = a?.name;
        if (!isValidAreaName(rawName)) continue;
        const name = displayName(rawName);
        if (seen.has(name)) continue;
        seen.add(name);
        filtered.push({ ...a, displayName: name });
      }
      return filtered;
    }

    function clearUI() {
      $("out").innerHTML = "";
      $("msg").textContent = "";
      $("cands").innerHTML = "";
      $("meta").textContent = "";
      $("toast").textContent = "";
      $("copyStatus").textContent = "";
    }

    function showCandidates(list) {
      if (!list.length) return;
      const wrap = document.createElement("div");

      const label = document.createElement("div");
      label.className = "muted";
      label.textContent = "è¿‘ã„å€™è£œï¼š";
      wrap.appendChild(label);

      const box = document.createElement("div");
      list.slice(0, 20).forEach((c) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "cand-btn";
        b.textContent = c;
        b.addEventListener("click", () => {
          $("q").value = c;
          run();
        });
        box.appendChild(b);
      });

      wrap.appendChild(box);
      $("cands").appendChild(wrap);
    }

    async function copyText(text) {
      // Clipboard API
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return;
      }
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }

    function showCopyFeedback(text) {
      const el = $("copyStatus");
      if (!el) return;
      const msg = `ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼š${text}`;
      el.textContent = msg;
      showToast(msg);
      setTimeout(() => {
        if (el.textContent === msg) el.textContent = "";
      }, 2000);
    }

    function nowStamp() {
      const d = new Date();
      const Y = d.getFullYear();
      const M = String(d.getMonth() + 1).padStart(2, "0");
      const D = String(d.getDate()).padStart(2, "0");
      const h = String(d.getHours()).padStart(2, "0");
      const m = String(d.getMinutes()).padStart(2, "0");
      return `${Y}/${M}/${D} ${h}:${m}`;
    }

    function loadHistory() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
      } catch {
        return [];
      }
    }

    function saveHistory(items) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(items));
    }

    let toastTimer = null;
    function showToast(message) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = message;
      el.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        el.classList.remove("show");
      }, 2000);
    }

    async function withLoading(btn, fn) {
      if (!btn) return fn();
      const prevText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "æŠ½é¸ä¸­â€¦";
      try {
        await fn();
      } finally {
        btn.disabled = false;
        btn.textContent = prevText;
      }
    }

    function setupSegmented(groupId, valueKey, currentValue, onChange) {
      const buttons = document.querySelectorAll(`#${groupId} button`);

      buttons.forEach((btn) => {
        const v = Number(btn.dataset.value);

        if (v === currentValue) {
          btn.classList.add("active");
        }

        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          localStorage.setItem(valueKey, v);
          onChange(v);
        });
      });
    }

    function renderHistory() {
      const list = loadHistory();
      const ul = $("history");
      ul.innerHTML = "";

      const clearBtn = $("clearHistory");
      const showCity = $("showCityPrefix")?.checked;
      const savedCity = localStorage.getItem(LAST_CITY_KEY) || "";
      const cityForHistory = currentCity || savedCity;
      if (!list.length) {
        $("historyEmpty").textContent = "å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“";
        if (clearBtn) clearBtn.disabled = true;
        return;
      }
      $("historyEmpty").textContent = "";
      if (clearBtn) clearBtn.disabled = false;

      for (const item of list) {
        const li = document.createElement("li");
        li.style.listStyle = "none";
        li.style.padding = "0";

        const row = document.createElement("button");
        row.type = "button";
        row.className = "history-item historyItem";

        const left = document.createElement("div");
        left.className = "history-text historyName";
        const baseName = item.text;
        const displayText =
          showCity && cityForHistory ? `${cityForHistory} ${baseName}`.trim() : baseName;
        left.textContent = displayText;

        const right = document.createElement("div");
        right.className = "history-meta historyTime";
        right.textContent = item.time;

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener("click", async () => {
          try {
            await copyText(item.text);
            showCopyFeedback(item.text);
          } catch {
            $("msg").textContent = "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ãŸâ€¦ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã‹ã‚‚ï¼‰";
          }
        });

        li.appendChild(row);
        ul.appendChild(li);
      }
    }

    function updateResultDisplay() {
      const showCity = $("showCityPrefix")?.checked;
      document.querySelectorAll(".result-item").forEach((btn) => {
        const city = btn.dataset.city || "";
        const nameEl = btn.querySelector(".result-name");
        const baseName = btn.dataset.copy || "";
        if (!nameEl) return;
        const text = showCity && city ? `${city} ${baseName}` : baseName;
        nameEl.textContent = text.trim();
      });
    }

    function addToHistory(text) {
      const list = loadHistory();

      // é€£ç¶šé‡è¤‡ã¯å…¥ã‚Œãªã„
      if (list[0] && list[0].text === text) return;

      list.unshift({ text, time: nowStamp() });

      if (list.length > HISTORY_MAX) list.length = HISTORY_MAX;

      saveHistory(list);
      renderHistory();
    }

    async function run() {
      clearUI();
      const q = $("q").value.trim();
      currentCity = "";
      if (!q) { $("msg").textContent = "å¸‚åŒºç”ºæ‘åã‚’å…¥ã‚Œã¦ã­"; return; }

      const codes = index[q];
      if (!codes) {
        const cands = Object.keys(index).filter(x => x.includes(q));
        if (cands.length) {
          $("msg").textContent = "å®Œå…¨ä¸€è‡´ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€‚å€™è£œã‹ã‚‰é¸ã‚“ã§ã­ã€‚";
          showCandidates(cands);
        } else {
          $("msg").textContent = "è¦‹ã¤ã‹ã‚‰ãªã„â€¦ã€‚ä¾‹ï¼šå‰æ©‹å¸‚ / æœ­å¹Œå¸‚ / å“å·åŒº";
        }
        return;
      }

      const code = codes[0];
      const v = data[code];
      currentCity = v.city || "";
      currentPref = v.pref || "";
      localStorage.setItem(LAST_CITY_KEY, currentCity);
      localStorage.setItem(LAST_PREF_KEY, currentPref);

      const topN = poolSize;
      const pickN = displayCount;

      const filtered = filterAreas(v.areas);
      const pool = filtered.slice(0, topN);

      if (!pool.length) {
        $("msg").textContent = "å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ã§é™¤å¤–ã•ã‚Œã¾ã—ãŸï¼‰";
        $("meta").innerHTML =
          `<span class="pill">${v.pref}</span> ` +
          `<span class="pill">${v.city}</span> ` +
          `<span class="pill">ãƒ•ã‚£ãƒ«ã‚¿å¾Œ0ä»¶</span>`;
        return;
      }

      const picks = sampleUnique(pool, pickN);

      if (pool.length < pickN) {
        $("msg").textContent = "å€™è£œãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ã§é™¤å¤–ã•ã‚Œã¾ã—ãŸï¼‰";
      }

      $("meta").innerHTML =
        `<span class="pill">${v.pref}</span> ` +
        `<span class="pill">${v.city}</span> ` +
        `<span class="pill">ãƒ•ã‚£ãƒ«ã‚¿å¾Œä¸Šä½${pool.length}ä»¶ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ${picks.length}</span>`;

      for (const a of picks) {
        const li = document.createElement("li");
        li.style.listStyle = "none";
        li.style.margin = "10px 0";
        li.style.padding = "0";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "result-item areaCard";

        const left = document.createElement("div");
        left.className = "result-left";

        const areaName = a.displayName || displayName(a.name);
        const showCity = $("showCityPrefix")?.checked;
        const displayText = showCity && v.city ? `${v.city} ${areaName}`.trim() : areaName;

        const name = document.createElement("div");
        name.className = "result-name area-title";
        name.textContent = displayText;

        const pop = document.createElement("div");
        pop.className = "result-pop";
        pop.textContent = `${a.pop.toLocaleString()}äºº`; // è¡¨ç¤ºã¯ã™ã‚‹ï¼ˆã‚³ãƒ”ãƒ¼ã¯ã—ãªã„ï¼‰

        left.appendChild(name);
        left.appendChild(pop);

        const hint = document.createElement("div");
        hint.className = "copy-hint";
        hint.textContent = "ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼";

        btn.dataset.copy = areaName;
        btn.dataset.city = v.city || "";
        btn.appendChild(left);
        btn.appendChild(hint);

        btn.addEventListener("click", async () => {
          // â˜…ã‚³ãƒ”ãƒ¼ã¯ç”ºåã ã‘
          const text = areaName;

          try {
            await copyText(text);
            showCopyFeedback(text);

            // â˜…å±¥æ­´ã¸è¿½åŠ 
            addToHistory(text);
          } catch (e) {
            $("msg").textContent = "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ãŸâ€¦ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã‹ã‚‚ï¼‰";
          }
        });

        li.appendChild(btn);
        $("out").appendChild(li);
      }

      // å±¥æ­´è¡¨ç¤ºã‚‚ç¾åœ¨ã®å¸‚åã«åˆã‚ã›ã¦å†æç”»
      renderHistory();
    }

    async function init() {
      clearUI();
      $("msg").textContent = "ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...";

      const res = await fetch("./areas_top10.json");
      data = await res.json();
      buildIndex();
      const savedCity = localStorage.getItem(LAST_CITY_KEY) || "";
      const savedPref = localStorage.getItem(LAST_PREF_KEY) || "";
      if (!currentCity && savedCity) currentCity = savedCity;
      if (!currentPref && savedPref) currentPref = savedPref;
      setupSegmented(
        "poolSizeGroup",
        POOL_SIZE_KEY,
        poolSize,
        (v) => (poolSize = v)
      );
      setupSegmented(
        "displayCountGroup",
        DISPLAY_COUNT_KEY,
        displayCount,
        (v) => (displayCount = v)
      );

      $("msg").textContent = "";
      const searchBtn = document.querySelector(".searchBtn");
      if (searchBtn) {
        searchBtn.addEventListener("click", () => {
          withLoading(searchBtn, run);
        });
      }
      const inputEl = document.querySelector("#q");
      if (inputEl && searchBtn) {
        inputEl.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            searchBtn.click();
          }
        });
      }

      $("clearHistory").addEventListener("click", () => {
        if (!confirm("ã‚³ãƒ”ãƒ¼å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        localStorage.removeItem(HISTORY_KEY);
        renderHistory();
        $("toast").textContent = "å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ãŸ";
        setTimeout(() => { $("toast").textContent = ""; }, 1200);
      });

      $("showCityPrefix").addEventListener("change", () => {
        updateResultDisplay();
        renderHistory();
      });

      renderHistory();
    }

    init();
  </script>
</body>
</html>
